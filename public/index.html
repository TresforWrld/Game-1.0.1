<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Quiz Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background: #f0f8ff; color: #222; }
    h1 { margin-bottom: 6px; }
    .top-row { margin: 10px 0; }
    input, select, button { padding: 6px; margin: 5px; }
    button { cursor: pointer; }
    #feedback { margin: 10px 0; min-height: 24px; }
    #leaderboard { margin-top: 20px; text-align: left; display: inline-block; }
  </style>
</head>
<body>

<h1>Quick Quiz Game</h1>
<div id="loginArea" class="top-row"></div>

<div class="top-row">
  <label for="subject">Choose subject:</label>
  <select id="subject" disabled>
    <option value="advancedmathematics">Advanced Mathematics</option>
    <option value="biology">Biology</option>
    <option value="chemistry">Chemistry</option>
    <option value="geography">Geography</option>
    <option value="history">History</option>
    <option value="ict">ICT</option>
    <option value="literature">Literature</option>
    <option value="physics">Physics</option>
    <option value="psychologyfacts">Psychology Facts</option>
    <option value="gk">General Knowledge</option>
    <option value="math">Math</option>
  </select>
</div>

<p id="questionTitle">Solve the problem:</p>
<h2 id="question">Loading‚Ä¶</h2>
<input id="answer" placeholder="Your answer" disabled>
<br>
<button id="submitBtn" disabled>Submit</button>

<p id="feedback"></p>

<p>Score: <span id="score">0</span> &nbsp;|&nbsp; High Score: <span id="highScore">0</span></p>
<p>Rank: <span id="rank">‚Äî</span> &nbsp;|&nbsp; Points to next: <span id="pointsToNext">‚Äî</span></p>

<div id="leaderboard">
  <h3 style="margin:6px 0 8px 0;">Leaderboard</h3>
  <ol id="leaderboardList" style="padding-left:1.2em;"></ol>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {

  const API_BASE = "."; // change if using server API
  let ranks = [];
  let currentRankIndex = parseInt(localStorage.getItem('rankIndex')) || 0;
  let score = parseInt(localStorage.getItem('score')) || 0;
  let highScore = parseInt(localStorage.getItem('highScore')) || 0;
  let username = null;
  let a, b, operator, correctAnswer;
  let gkQuestions = [];
  let subjectQuestions = {};

  const questionEl = document.getElementById('question');
  const answerInput = document.getElementById('answer');
  const submitBtn = document.getElementById('submitBtn');
  const subjectSelect = document.getElementById('subject');
  const scoreEl = document.getElementById('score');
  const highScoreEl = document.getElementById('highScore');
  const rankEl = document.getElementById('rank');
  const nextEl = document.getElementById('pointsToNext');
  const feedbackEl = document.getElementById('feedback');
  const leaderboardList = document.getElementById('leaderboardList');
  const loginArea = document.getElementById('loginArea');

  const subjectsList = [
    'advancedmathematics','biology','chemistry','geography','history',
    'ict','literature','physics','psychologyfacts','math'
  ];

  /* ===== Helpers ===== */
  function setUIEnabled(enabled){
    answerInput.disabled = !enabled;
    submitBtn.disabled = !enabled;
    subjectSelect.disabled = !enabled;
  }

  function updateDisplay(){
    scoreEl.textContent = score;
    highScoreEl.textContent = highScore;
    rankEl.textContent = (ranks[currentRankIndex]?.name) || '‚Äî';
    const needed = ranks[currentRankIndex]?.points;
    nextEl.textContent = (typeof needed === 'number') ? Math.max(0, needed - score) : '‚Äî';
  }

  function sanitizeRankIndex(){
    if (!Array.isArray(ranks) || ranks.length === 0){ currentRankIndex = 0; return; }
    if (currentRankIndex < 0 || currentRankIndex >= ranks.length) currentRankIndex = 0;
  }

  /* ===== Question Generation (simplified) ===== */
  function generateQuestion(){
    const subject = subjectSelect.value || 'math';

    if(subject === 'math'){
      a = Math.floor(Math.random()*10)+1;
      b = Math.floor(Math.random()*10)+1;
      const ops = ['+','-','*'];
      operator = ops[Math.floor(Math.random()*ops.length)];
      if(operator === '+') correctAnswer = a+b;
      else if(operator === '-') correctAnswer = a-b;
      else correctAnswer = a*b;
      questionEl.textContent = `${a} ${operator} ${b} = ?`;
      answerInput.type='number';
      answerInput.value='';
      feedbackEl.textContent='';
      answerInput.disabled=false;
      submitBtn.disabled=false;
    } else if(subject === 'gk'){
      if(!gkQuestions.length){
        questionEl.textContent="GK questions loading...";
        answerInput.disabled=true;
        submitBtn.disabled=true;
        return;
      }
      const q = gkQuestions[Math.floor(Math.random()*gkQuestions.length)];
      questionEl.textContent = q.question;
      correctAnswer = String(q.answer).trim().toLowerCase();
      answerInput.type='text';
      answerInput.value='';
      answerInput.disabled=false;
      submitBtn.disabled=false;
      feedbackEl.textContent='';
    } else {
      const pool = subjectQuestions[subject];
      if(!Array.isArray(pool)||!pool.length){
        questionEl.textContent=`No questions for ${subject}`;
        answerInput.disabled=true;
        submitBtn.disabled=true;
        feedbackEl.textContent='';
        return;
      }
      const q = pool[Math.floor(Math.random()*pool.length)];
      questionEl.textContent=q.question;
      if(Array.isArray(q.options)){
        correctAnswer = q.answer;
        feedbackEl.innerHTML = q.options.map(o=>`<button class="optionBtn">${o}</button>`).join(" ");
        answerInput.disabled=true;
        submitBtn.disabled=false;
        document.querySelectorAll('.optionBtn').forEach(btn=>btn.onclick=()=>checkAnswer(btn.textContent));
      } else {
        correctAnswer = String(q.answer).trim().toLowerCase();
        answerInput.disabled=false;
        submitBtn.disabled=false;
        feedbackEl.innerHTML='';
      }
    }
  }

  /* ===== Answer Check ===== */
  function checkAnswer(opt=null){
    if(correctAnswer==null){ feedbackEl.textContent="No question ready."; return; }
    const raw = opt ?? answerInput.value.trim();
    if(!raw){ feedbackEl.textContent="Please enter an answer."; return; }
    let correct=false;
    if(subjectSelect.value==='math'){ correct = Number(raw)===correctAnswer; }
    else correct = raw.toLowerCase()===correctAnswer.toLowerCase();
    feedbackEl.textContent = correct ? "‚úÖ Correct!" : `‚ùå Wrong! Answer: ${correctAnswer}`;
    if(correct) score++;
    highScore=Math.max(highScore,score);
    localStorage.setItem('score',score);
    localStorage.setItem('highScore',highScore);
    updateDisplay();
    setTimeout(generateQuestion,1500);
  }

  submitBtn.addEventListener('click',()=>checkAnswer());
  answerInput.addEventListener('keydown',e=>{ if(e.key==='Enter') checkAnswer(); });

  /* ===== Load Questions (simplified) ===== */
  function fetchJSON(path){ return fetch(path).then(r=>r.json()).catch(()=>[]); }
  function loadAllQuestions(){
    fetchJSON('gk.json').then(data=>{ gkQuestions=data; console.log('GK loaded:',data.length); });
    subjectsList.forEach(sub=>fetchJSON(`questions/${sub}.json`).then(d=>{ subjectQuestions[sub]=d; console.log(sub,d.length); }));
    setUIEnabled(true);
    generateQuestion();
  }

  /* ===== Init ===== */
  loadAllQuestions();

});
</script>

<footer>
  ¬©2025 ANICADE ‚õ©Ô∏è Productions (ANICADE's ELEVATE)
</footer>
</body>
</html>// always update localStorage
  localStorage.setItem('score', String(score));
  localStorage.setItem('highScore', String(highScore));
  localStorage.setItem('rankIndex', String(currentRankIndex));

  if (!username) return; // do not post to server without username

  fetch(`/user/${encodeURIComponent(username)}`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ score, highScore, currentRankIndex })
  }).catch(err => console.error('Save user failed:', err));
}

/* ===== Leaderboard ===== */
function loadLeaderboard() {
  fetch('/users')
    .then(res => {
      if (!res.ok) throw new Error('Failed to load users');
      return res.json();
    })
    .then(data => {

      if (!data || typeof data !== 'object') {
        leaderboardList.innerHTML = '<li>No leaderboard data found</li>';
        return;
      }

      const list = Object.entries(data)
        .map(([user, stats]) => ({
          user,
          highScore: Number(stats?.highScore) || 0,
          currentRankIndex: Number(stats?.currentRankIndex) || 0
        }))
        .sort((a, b) => b.highScore - a.highScore); // show ALL users

      leaderboardList.innerHTML = '';

      list.forEach((item, index) => {

        // medals for top 3
        let medal = '';
        if (index === 0) medal = 'ü•á ';
        if (index === 1) medal = 'ü•à ';
        if (index === 2) medal = 'ü•â ';

        // safe rank name
        const rankName =
          Array.isArray(ranks) &&
          ranks[item.currentRankIndex] &&
          ranks[item.currentRankIndex].name
            ? ranks[item.currentRankIndex].name
            : '‚Äî';

        // entry
        const li = document.createElement('li');
        li.textContent = `${medal}${item.user} ‚Äî ${item.highScore} pts ‚Äî Rank: ${rankName}`;
        leaderboardList.appendChild(li);

        // separator
        if (index < list.length - 1) {
          const sep = document.createElement('div');
          sep.textContent = '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
          sep.style.textAlign = 'center';
          sep.style.color = '#888';
          sep.style.margin = '4px 0';
          leaderboardList.appendChild(sep);
        }
      });
    })
    .catch(err => {
      console.error('Leaderboard error:', err);
      leaderboardList.innerHTML = '<li>Error loading leaderboard</li>';
    });
}
let gkQuestions = [];
let subjectQuestions = {}; // cache for each subject

const subjectsList = [
  'advancedmathematics',
  'biology',
  'chemistry',
  'geography',
  'history',
  'ict',
  'literature',
  'physics',
  'psychologyfacts'
];

// Helper to fetch JSON safely
function fetchJSON(path) {
  return fetch(path)
    .then(res => {
      if (!res.ok) throw new Error(`${path} not found: ${res.status}`);
      return res.json();
    })
    .catch(err => {
      console.warn(err);
      return []; // fallback to empty array
    });
}

// Load GK questions and other subjects
function loadAllQuestions() {
  const allFetches = [
    fetchJSON('gk.json').then(data => { gkQuestions = data; console.log('GK loaded:', gkQuestions.length); })
  ];

  subjectsList.forEach(sub => {
    allFetches.push(
      fetchJSON(`/questions/${sub}.json`).then(data => {
        subjectQuestions[sub] = data;
        console.log(`${sub} loaded:`, data.length);
      })
    );
  });

  // Enable UI only after all questions are loaded
  return Promise.all(allFetches).then(() => {
    console.log('All subjects loaded.');
    setUIEnabled(true);
    generateQuestion();
  });
}

// Call this once on page load
loadAllQuestions();
  
/* ===== Load ranks then user ===== */
function fetchRanksThenStart(){
  // ranks.json must be in /public/ranks.json so static server serves it at /ranks.json
  fetch('/ranks.json')
    .then(res => {
      if (!res.ok) throw new Error('ranks.json not found (status ' + res.status + ')');
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) throw new Error('ranks.json invalid');
      ranks = data;
      sanitizeRankIndex();
      // restore saved subject here too (in case it was set earlier)
      const saved = localStorage.getItem('quiz_subject');
      if (saved && Array.from(subjectSelect.options).some(o => o.value === saved)) {
        subjectSelect.value = saved;
      }
      setUIEnabled(true);
      updateDisplay();
      generateQuestion();
      loadLeaderboard();
      console.log('Ranks loaded:', ranks);
    })
    .catch(err => {
      console.error('Failed to load ranks:', err);
      questionEl.textContent = 'Error loading ranks.';
      feedbackEl.textContent = 'Check ranks.json on server.';
    });
}

/* ===== Login / Load user ===== */
function createLoginControls(){
  const saved = localStorage.getItem('quiz_username');
  const input = document.createElement('input');
  input.placeholder = 'username';
  input.style.padding = '8px';
  input.style.fontSize = '14px';
  input.value = saved || '';

  const btn = document.createElement('button');
  btn.textContent = saved ? 'Use saved / Switch' : 'Login';
  btn.onclick = () => {
    const val = (input.value || '').trim();
    if (!val) { alert('Enter a username (letters/numbers).'); return; }
    username = val;
    localStorage.setItem('quiz_username', username);
    loginArea.innerHTML = `Logged in as: <strong>${username}</strong>`;
    // load user data then ranks
    fetch(`/user/${encodeURIComponent(username)}`)
      .then(res => {
        if (!res.ok) throw new Error('User not found');
        return res.json();
      })
      .then(data => {
        // prefer server values, but validate them
        score = Number.isFinite(data.score) ? data.score : (parseInt(localStorage.getItem('score')) || 0);
        highScore = Number.isFinite(data.highScore) ? data.highScore : (parseInt(localStorage.getItem('highScore')) || 0);
        currentRankIndex = Number.isFinite(data.currentRankIndex) ? data.currentRankIndex : (parseInt(localStorage.getItem('rankIndex')) || 0);
        updateDisplay();
        fetchRanksThenStart();
      })
      .catch(() => {
        // New user or server missing ‚Äî use localStorage fallback
        score = parseInt(localStorage.getItem('score')) || 0;
        highScore = parseInt(localStorage.getItem('highScore')) || 0;
        currentRankIndex = parseInt(localStorage.getItem('rankIndex')) || 0;
        updateDisplay();
        fetchRanksThenStart();
      });
  };

  const clearBtn = document.createElement('button');
  clearBtn.textContent = 'Clear saved';
  clearBtn.onclick = () => {
    localStorage.removeItem('quiz_username');
    input.value = '';
    username = null;
    loginArea.innerHTML = '';
    createLoginControls(); // recreate
    setUIEnabled(false);
  };

  loginArea.appendChild(input);
  loginArea.appendChild(btn);
  loginArea.appendChild(clearBtn);
}

/* ===== Subject change persistence ===== */
// Save subject when the user changes it, and regenerate a question if UI is enabled.
subjectSelect.addEventListener('change', () => {
  localStorage.setItem('quiz_subject', subjectSelect.value);
  // only regenerate if UI is enabled (avoids running before ranks loaded)
  if (!answerInput.disabled) {
    generateQuestion();
  }
});

<script>
/* ===== State & DOM refs ===== */
const API_BASE = "https://game-1-0-1.onrender.com";

let ranks = [];
let currentRankIndex = parseInt(localStorage.getItem('rankIndex')) || 0;
let score = parseInt(localStorage.getItem('score')) || 0;
let highScore = parseInt(localStorage.getItem('highScore')) || 0;
let username = null;
let a, b, operator, correctAnswer;
let gkQuestions = [];
let subjectQuestions = {};

let savedSubject = localStorage.getItem('quiz_subject') || null;

const questionEl = document.getElementById('question');
const answerInput = document.getElementById('answer');
const submitBtn = document.getElementById('submitBtn');
const subjectSelect = document.getElementById('subject');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const rankEl = document.getElementById('rank');
const nextEl = document.getElementById('pointsToNext');
const feedbackEl = document.getElementById('feedback');
const leaderboardList = document.getElementById('leaderboardList');
const loginArea = document.getElementById('loginArea');

if (savedSubject) {
  const opt = [...subjectSelect.options].find(o => o.value === savedSubject);
  if (opt) subjectSelect.value = savedSubject;
}

function setUIEnabled(en){
  answerInput.disabled = !en;
  submitBtn.disabled = !en;
  subjectSelect.disabled = !en;
}

function updateDisplay(){
  scoreEl.textContent = score;
  highScoreEl.textContent = highScore;
  rankEl.textContent = ranks[currentRankIndex]?.name || "‚Äî";
  nextEl.textContent = ranks[currentRankIndex] ? Math.max(0, ranks[currentRankIndex].points - score) : "‚Äî";
}

function sanitizeRankIndex(){
  if (!Array.isArray(ranks) || ranks.length === 0) currentRankIndex = 0;
  if (currentRankIndex < 0 || currentRankIndex >= ranks.length) currentRankIndex = 0;
}

function pointsNeeded(i){
  if (!ranks[i]) return Infinity;
  return ranks[i].points;
}

function checkLevelUp(){
  if (!ranks.length) return;

  let changed = false;
  while (currentRankIndex < ranks.length && score >= pointsNeeded(currentRankIndex)) {
    currentRankIndex++;
    changed = true;
    if (currentRankIndex >= ranks.length) {
      alert("üéâ You reached the ultimate rank!");
      score = 0;
      currentRankIndex = 0;
      break;
    } else {
      alert("‚≠ê Rank Up: " + ranks[currentRankIndex].name);
    }
  }
  if (changed) saveUser();
  updateDisplay();
}

function generateQuestion(){
  if (!ranks.length){
    questionEl.textContent = "Waiting for ranks...";
    return;
  }

  const subject = subjectSelect.value || "math";

  /* MATH */
  if (subject === 'math'){
    answerInput.type = "number";
    answerInput.inputMode = "numeric";

    let maxNumber = Math.max(10, 10 + currentRankIndex * 5);

    a = Math.floor(Math.random()*maxNumber)+1;
    b = Math.floor(Math.random()*maxNumber)+1;

    const ops = ['+','-','*','/'];
    operator = ops[Math.floor(Math.random()*ops.length)];

    if (operator === '+') correctAnswer = a + b;
    else if (operator === '-') correctAnswer = a - b;
    else if (operator === '*') correctAnswer = a * b;
    else { a = a * b; correctAnswer = a / b; }

    questionEl.textContent = `${a} ${operator} ${b} = ?`;
    answerInput.value = "";
    feedbackEl.textContent = "";
    answerInput.disabled = false;
    submitBtn.disabled = false;
    return;
  }

  /* GK */
  if (subject === 'gk'){
    answerInput.type = "text";
    answerInput.inputMode = "text";

    if (!gkQuestions.length){
      questionEl.textContent = "GK questions loading...";
      return;
    }

    const q = gkQuestions[Math.floor(Math.random()*gkQuestions.length)];
    questionEl.textContent = q.question;
    correctAnswer = q.answer.toString().trim().toLowerCase();
    answerInput.value = "";
    feedbackEl.textContent = "";
    answerInput.disabled = false;
    submitBtn.disabled = false;
    return;
  }

  
/* ===== LOAD GK ===== */
fetch(`${API_BASE}/gk.json`)
  .then(r=>r.json())
  .then(j=> gkQuestions = Array.isArray(j) ? j : [])
  .catch(()=>console.warn("Failed loading GK"));

/* ===== LOAD SUBJECT QUESTIONS ===== */
const subjectsList=[
  'advancedmathematics','biology','chemistry','geography','history',
  'ict','literature','physics','psychologyfacts'
];

subjectsList.forEach(sub=>{
  fetch(`${API_BASE}/questions/${sub}.json`)
    .then(r=>r.json())
    .then(j=>{
      if (Array.isArray(j)) subjectQuestions[sub] = j;
    })
    .catch(()=>console.warn("Missing subject:", sub));
});

/* ===== LOAD RANKS THEN START ===== */
function fetchRanksThenStart(){
  fetch(`${API_BASE}/ranks.json`)
    .then(r=>r.json())
    .then(j=>{
      ranks = j;
      sanitizeRankIndex();
      if (savedSubject) subjectSelect.value = savedSubject;

      setUIEnabled(true);
      updateDisplay();
      generateQuestion();
      loadLeaderboard();
    })
    .catch(err=>{
      console.error("Ranks error:", err);
      questionEl.textContent = "Error loading ranks.";
    });
}

/* ===== LOGIN ===== */
function createLoginControls(){
  const saved = localStorage.getItem('quiz_username');

  const input=document.createElement('input');
  input.placeholder="username";
  input.value=saved||"";
  input.style.padding="8px";

  const btn=document.createElement('button');
  btn.textContent = saved ? "Use saved / Switch" : "Login";

  btn.onclick = ()=>{
    const v=input.value.trim();
    if (!v){ alert("Enter username"); return; }

    username = v;
    localStorage.setItem('quiz_username', username);

    loginArea.innerHTML = `Logged in as: <strong>${username}</strong>`;

    fetch(`${API_BASE}/user/${encodeURIComponent(username)}`)
      .then(r=>r.json())
      .then(d=>{
        score = d.score ?? score;
        highScore = d.highScore ?? highScore;
        currentRankIndex = d.currentRankIndex ?? currentRankIndex;
        updateDisplay();
        fetchRanksThenStart();
      })
      .catch(()=>{
        updateDisplay();
        fetchRanksThenStart();
      });
  };

  const clearBtn=document.createElement('button');
  clearBtn.textContent="Clear saved";
  clearBtn.onclick=()=>{
    localStorage.removeItem('quiz_username');
<script>
/* ===== CONFIG ===== */
const API_BASE = ''; // '' if JSONs are in root, or '/questions' if in folder

/* ===== GLOBALS ===== */
let ranks = [];
let currentRankIndex = parseInt(localStorage.getItem('rankIndex')) || 0;
let score = parseInt(localStorage.getItem('score')) || 0;
let highScore = parseInt(localStorage.getItem('highScore')) || 0;
let username = null;
let a, b, operator, correctAnswer;

let gkQuestions = [];
let subjectQuestions = {}; // cache for each subject

const subjectsList = [
  'advancedmathematics','biology','chemistry','geography','history',
  'ict','literature','physics','psychologyfacts'
];

const questionEl = document.getElementById('question');
const answerInput = document.getElementById('answer');
const submitBtn = document.getElementById('submitBtn');
const subjectSelect = document.getElementById('subject');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const rankEl = document.getElementById('rank');
const nextEl = document.getElementById('pointsToNext');
const feedbackEl = document.getElementById('feedback');
const leaderboardList = document.getElementById('leaderboardList');
const loginArea = document.getElementById('loginArea');

const savedSubject = localStorage.getItem('quiz_subject');
if (savedSubject) {
  const opt = Array.from(subjectSelect.options).find(o => o.value === savedSubject);
  if (opt) subjectSelect.value = savedSubject;
}

/* ===== HELPERS ===== */
function setUIEnabled(enabled){
  answerInput.disabled = !enabled;
  submitBtn.disabled = !enabled;
  subjectSelect.disabled = !enabled;
}

function updateDisplay(){
  scoreEl.textContent = score;
  highScoreEl.textContent = highScore;
  rankEl.textContent = (ranks[currentRankIndex]?.name) || '‚Äî';
  const needed = ranks[currentRankIndex]?.points;
  nextEl.textContent = (typeof needed === 'number') ? Math.max(0, needed - score) : '‚Äî';
}

function sanitizeRankIndex(){
  if (!Array.isArray(ranks) || ranks.length === 0) { currentRankIndex = 0; return; }
  if (currentRankIndex < 0 || currentRankIndex >= ranks.length) currentRankIndex = 0;
}

function pointsNeeded(idx){
  return ranks[idx]?.points ?? Infinity;
}

function checkLevelUp(){
  if (!Array.isArray(ranks) || ranks.length === 0) return;
  let changed = false;
  while (currentRankIndex < ranks.length && score >= pointsNeeded(currentRankIndex)){
    currentRankIndex++;
    changed = true;
    if (currentRankIndex >= ranks.length){
      alert(`üéâ You reached the ultimate rank: ${ranks[ranks.length-1].name}!`);
      score = 0; currentRankIndex = 0; break;
    } else {
      alert(`‚≠ê Congrats! You ranked up to: ${ranks[currentRankIndex].name}`);
    }
  }
  if (changed) saveUser();
  updateDisplay();
}

/* ===== QUESTION GENERATION ===== */
function generateQuestion() {
  if (!Array.isArray(ranks) || ranks.length === 0) {
    questionEl.textContent = 'Waiting for ranks...';
    return;
  }

  const subject = subjectSelect.value || 'math';

  // ----- MATH -----
  if (subject === 'math') {
    answerInput.type = 'number';
    answerInput.inputMode = 'numeric';
    const maxNumber = Math.max(10, 10 + currentRankIndex * 5);
    a = Math.floor(Math.random() * maxNumber) + 1;
    b = Math.floor(Math.random() * maxNumber) + 1;
    const operators = ['+', '-', '*', '/'];
    operator = operators[Math.floor(Math.random() * operators.length)];
    if (operator === '+') correctAnswer = a + b;
    else if (operator === '-') correctAnswer = a - b;
    else if (operator === '*') correctAnswer = a * b;
    else { a = a * b; correctAnswer = a / b; }
    questionEl.textContent = `${a} ${operator} ${b} = ?`;
    answerInput.value = ''; feedbackEl.textContent = '';
    answerInput.disabled = false; submitBtn.disabled = false;
    return;
  }

  // ----- GENERAL KNOWLEDGE -----
  if (subject === 'gk') {
    answerInput.type = 'text';
    answerInput.inputMode = 'text';
    if (!Array.isArray(gkQuestions) || gkQuestions.length === 0){
      questionEl.textContent = "GK questions loading...";
      correctAnswer = null; answerInput.value = ''; feedbackEl.textContent = '';
      return;
    }
    const q = gkQuestions[Math.floor(Math.random() * gkQuestions.length)];
    questionEl.textContent = q.question;
    correctAnswer = String(q.answer).trim().toLowerCase();
    answerInput.value = ''; feedbackEl.textContent = '';
    answerInput.disabled = false; submitBtn.disabled = false;
    return;
  }

  // ----- OTHER SUBJECTS -----
  const pool = subjectQuestions[subject];
  if (!Array.isArray(pool) || !pool.length){
    questionEl.textContent = "No questions for " + subject;
    correctAnswer = null;
    answerInput.disabled = true; submitBtn.disabled = true; feedbackEl.innerHTML = "";
    return;
  }

  const q = pool[Math.floor(Math.random() * pool.length)];
  questionEl.textContent = q.question;

  if (Array.isArray(q.options) && q.options.length){
    correctAnswer = q.answer;
    feedbackEl.innerHTML = q.options.map(o => `<button class="optionBtn">${o}</button>`).join(" ");
    answerInput.disabled = true; submitBtn.disabled = false;
    document.querySelectorAll('.optionBtn').forEach(btn => {
      btn.onclick = () => checkAnswer(btn.textContent);
    });
  } else {
    correctAnswer = String(q.answer).trim().toLowerCase();
    feedbackEl.innerHTML = "";
    answerInput.disabled = false; submitBtn.disabled = false;
  }
}

/* ===== CHECK ANSWER ===== */
function checkAnswer(opt=null){
  if (correctAnswer == null){
    feedbackEl.textContent = "No question ready."; return;
  }

  const subject = subjectSelect.value || "math";
  const raw = opt ?? answerInput.value.trim();
  if (!raw){ feedbackEl.textContent = "Please enter an answer."; return; }

  let correct = false;
  if (subject === 'math'){
    const val = Number(raw);
    if (isNaN(val)){ feedbackEl.textContent="Enter a valid number."; return; }
    correct = val === correctAnswer;
  } else {
    correct = raw.toLowerCase() === correctAnswer.toLowerCase();
  }

  feedbackEl.textContent = correct ? "‚úÖ Correct!" : `‚ùå Wrong! Answer: ${correctAnswer}`;
  if (correct) score++;
  highScore = Math.max(highScore, score);

  localStorage.setItem("score", score);
  localStorage.setItem("highScore", highScore);
  localStorage.setItem("rankIndex", currentRankIndex);

  updateDisplay(); checkLevelUp(); saveUser();

  setTimeout(()=>{
    feedbackEl.innerHTML = "";
    generateQuestion();
  }, 2000);
}

answerInput.addEventListener('keydown', e=>{
  if (e.key === 'Enter') checkAnswer();
});

/* ===== SAVE USER ===== */
function saveUser(){
  localStorage.setItem('score', score);
  localStorage.setItem('highScore', highScore);
  localStorage.setItem('rankIndex', currentRankIndex);

  if (!username) return;

  fetch(`${API_BASE}/user/${encodeURIComponent(username)}`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({score, highScore, currentRankIndex})
  }).catch(err=>console.error("Save user failed:", err));
}

/* ===== LEADERBOARD ===== */
function loadLeaderboard(){
  fetch(`${API_BASE}/users`)
    .then(r=>r.json())
    .then(data=>{
      if (!data) { leaderboardList.innerHTML = "<li>No data</li>"; return; }
      const list = Object.entries(data).map(([u,s])=>({
        user:u, highScore:Number(s?.highScore)||0, currentRankIndex:Number(s?.currentRankIndex)||0
      })).sort((a,b)=>b.highScore-a.highScore);

      leaderboardList.innerHTML = "";
      list.forEach((item,i)=>{
        const medal = i===0?'ü•á ':i===1?'ü•à ':i===2?'ü•â ':'';
        const rankName = ranks[item.currentRankIndex]?.name || "‚Äî";
        const li = document.createElement('li');
        li.textContent = `${medal}${item.user} ‚Äî ${item.highScore} pts ‚Äî Rank: ${rankName}`;
        leaderboardList.appendChild(li);
      });
    })
    .catch(err=>{ console.error("Leaderboard error:", err); leaderboardList.innerHTML="<li>Error loading leaderboard</li>"; });
}

/* ===== LOAD JSON FILES ===== */
function fetchJSON(path){
  return fetch(path)
    .then(r=>{ if(!r.ok) throw new Error(`${path} not found`); return r.json(); })
    .catch(err=>{ console.warn(err); return []; });
}

function loadAllQuestions(){
  const fetches = [fetchJSON('gk.json').then(data=>{ gkQuestions=data; console.log('GK loaded', gkQuestions.length); })];
  subjectsList.forEach(sub=>{
    fetches.push(fetchJSON(`/questions/${sub}.json`).then(data=>{ subjectQuestions[sub]=data; console.log(`${sub} loaded`, data.length); }));
  });
  return Promise.all(fetches).then(()=>{ console.log('All subjects loaded'); setUIEnabled(true); generateQuestion(); });
}

/* ===== LOAD RANKS ===== */
function fetchRanksThenStart(){
  fetchJSON('ranks.json').then(j=>{
    ranks = j;
    sanitizeRankIndex();
    if (savedSubject) subjectSelect.value = savedSubject;
    setUIEnabled(true);
    updateDisplay();
    generateQuestion();
    loadLeaderboard();
  }).catch(err=>{
    console.error("Ranks error:", err); questionEl.textContent="Error loading ranks.";
  });
}

/* ===== LOGIN ===== */
function createLoginControls(){
  const saved = localStorage.getItem('quiz_username');

  const input = document.createElement('input');
  input.placeholder="username"; input.value=saved||""; input.style.padding="8px";

  const btn = document.createElement('button');
  btn.textContent = saved ? "Use saved / Switch" : "Login";

  btn.onclick = ()=>{
    const v = input.value.trim();
    if(!v){ alert("Enter username"); return; }
    username=v; localStorage.setItem('quiz_username', username);
    loginArea.innerHTML=`Logged in as: <strong>${username}</strong>`;
    fetch(`${API_BASE}/user/${encodeURIComponent(username)}`).then(r=>r.json())
      .then(d=>{
        score=d.score??score; highScore=d.highScore??highScore; currentRankIndex=d.currentRankIndex??currentRankIndex;
        updateDisplay(); fetchRanksThenStart();
      }).catch(()=>{ updateDisplay(); fetchRanksThenStart(); });
  };

  const clearBtn=document.createElement('button');
  clearBtn.textContent="Clear saved"; clearBtn.onclick=()=>{
    localStorage.removeItem('quiz_username'); loginArea.innerHTML=""; username=null; createLoginControls(); setUIEnabled(false);
  };

  loginArea.appendChild(input); loginArea.appendChild(btn); loginArea.appendChild(clearBtn);
}

/* ===== SUBJECT CHANGE ===== */
subjectSelect.addEventListener('change', ()=>{
  localStorage.setItem('quiz_subject', subjectSelect.value);
  if (!answerInput.disabled) generateQuestion();
});

/* ===== INIT ===== */
(function init(){
  setUIEnabled(false); createLoginControls();

  const s = localStorage.getItem('quiz_username');
  if (s){
    username=s; loginArea.innerHTML=`Logged in as: <strong>${username}</strong>`;
    fetch(`${API_BASE}/user/${encodeURIComponent(username)}`).then(r=>r.json())
      .then(d=>{
        score=d.score??score; highScore=d.highScore??highScore; currentRankIndex=d.currentRankIndex??currentRankIndex;
        updateDisplay(); fetchRanksThenStart();
      }).catch(()=>{ updateDisplay(); fetchRanksThenStart(); });
  } else fetchRanksThenStart();
})();
</script>
<footer>
  ¬©2025 ANICADE ‚õ©Ô∏è Productions (ANICADE's ELEVATE)
</footer>
</body>
</html>
