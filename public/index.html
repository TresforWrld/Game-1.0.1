<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quick Quiz Game</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; margin:40px 10px 110px; background:#f0f8ff; color:#222; }
  h1 { margin-bottom:6px; }
  button, select { padding:10px 18px; font-size:15px; margin-top:10px; cursor:pointer; }
  input[type="text"], input[type="number"]{ font-size:16px; padding:6px; width:120px; }
  #score,#highScore,#rank,#pointsToNext{ font-weight:700; }
  #feedback{ min-height:1.4em; margin-top:10px; }
  #leaderboard{ margin-top:18px; text-align:left; display:inline-block; width:260px; }
  footer{ background:#808080; color:#fff; padding:12px; font-size:13px; position:fixed; bottom:0; left:0; right:0; box-sizing:border-box; }
  .top-row{ display:flex; justify-content:center; gap:12px; align-items:center; flex-wrap:wrap; }
  @media (max-width:420px){ #leaderboard{ width:92%; } input[type="text"], input[type="number"]{ width:86%; } }
</style>
</head>
<body>

  <h1>Quick Quiz Game</h1>
  <div id="loginArea" class="top-row"></div>

  <div class="top-row">
    <label for="subject">Choose subject:</label>
    <select id="subject" disabled>
      <option value="math">Math</option>
      <option value="gk">General Knowledge</option>
    </select>
  </div>

  <p id="questionTitle">Solve the problem:</p>
  <h2 id="question">Loading‚Ä¶</h2>

  <!-- note: type will be switched dynamically between number/text -->
  <input id="answer" placeholder="Your answer" disabled>
  <br>
  <button id="submitBtn" onclick="checkAnswer()" disabled>Submit</button>

  <p id="feedback"></p>

  <p>Score: <span id="score">0</span> &nbsp;|&nbsp; High Score: <span id="highScore">0</span></p>

  <p>Rank: <span id="rank">‚Äî</span> &nbsp;|&nbsp; Points to next: <span id="pointsToNext">‚Äî</span></p>

  <div id="leaderboard">
    <h3 style="margin:6px 0 8px 0;">Leaderboard</h3>
    <ol id="leaderboardList" style="padding-left:1.2em;"></ol>
  </div>

<script>
/* ===== State & DOM refs ===== */
let ranks = [];
let currentRankIndex = parseInt(localStorage.getItem('rankIndex')) || 0;
let score = parseInt(localStorage.getItem('score')) || 0;
let highScore = parseInt(localStorage.getItem('highScore')) || 0;
let username = null;
let a, b, operator, correctAnswer;
let gkQuestions = [];

// restore saved subject (applied early)
let savedSubject = localStorage.getItem('quiz_subject') || null;

const questionEl = document.getElementById('question');
const answerInput = document.getElementById('answer');
const submitBtn = document.getElementById('submitBtn');
const subjectSelect = document.getElementById('subject');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const rankEl = document.getElementById('rank');
const nextEl = document.getElementById('pointsToNext');
const feedbackEl = document.getElementById('feedback');
const leaderboardList = document.getElementById('leaderboardList');
const loginArea = document.getElementById('loginArea');

/* If we have a saved subject, set it now so generateQuestion uses it after ranks load */
if (savedSubject) {
  // only set if the option exists (safety)
  const opt = Array.from(subjectSelect.options).find(o => o.value === savedSubject);
  if (opt) subjectSelect.value = savedSubject;
}

/* ===== Helpers ===== */
function setUIEnabled(enabled){
  answerInput.disabled = !enabled;
  submitBtn.disabled = !enabled;
  subjectSelect.disabled = !enabled;
}

function updateDisplay(){
  scoreEl.textContent = score;
  highScoreEl.textContent = highScore;
  rankEl.textContent = (ranks[currentRankIndex] && ranks[currentRankIndex].name) || '‚Äî';
  const needed = (ranks[currentRankIndex] && ranks[currentRankIndex].points);
  nextEl.textContent = (typeof needed === 'number') ? Math.max(0, needed - score) : '‚Äî';
}

function sanitizeRankIndex(){
  if (!Array.isArray(ranks) || ranks.length === 0){ currentRankIndex = 0; return; }
  if (currentRankIndex < 0 || currentRankIndex >= ranks.length) currentRankIndex = 0;
}

/* ===== Leveling ===== */
function pointsNeeded(idx){
  if (!Array.isArray(ranks) || idx < 0 || idx >= ranks.length) return Infinity;
  return ranks[idx].points;
}

function checkLevelUp(){
  if (!Array.isArray(ranks) || ranks.length === 0) return;
  let changed = false;
  while (currentRankIndex < ranks.length && score >= pointsNeeded(currentRankIndex)) {
    currentRankIndex++;
    changed = true;
    if (currentRankIndex >= ranks.length) {
      alert(`üéâ You reached the ultimate rank: ${ranks[ranks.length-1].name}!`);
      score = 0; // reset for replay (you can change this behavior)
      currentRankIndex = 0;
      break;
    } else {
      alert(`‚≠ê Congrats! You ranked up to: ${ranks[currentRankIndex].name}`);
    }
  }
  if (changed) saveUser();
  updateDisplay();
}

/* ===== Question generation ===== */
function generateQuestion() {
  if (!Array.isArray(ranks) || ranks.length === 0) {
    questionEl.textContent = 'Waiting for ranks...';
    return;
  }

  const subject = subjectSelect.value || 'math';

  if (subject === 'math') {
    // set answer input to numeric mode
    try { answerInput.type = 'number'; } catch(e){}
    try { answerInput.inputMode = 'numeric'; } catch(e){}

    // difficulty scaling
    let maxNumber = 10 + (currentRankIndex * 5);
    maxNumber = Math.max(10, Math.floor(maxNumber));

    a = Math.floor(Math.random() * maxNumber) + 1;
    b = Math.floor(Math.random() * maxNumber) + 1;

    const operators = ['+', '-', '*', '/'];
    operator = operators[Math.floor(Math.random() * operators.length)];

    if (operator === '+') correctAnswer = a + b;
    else if (operator === '-') correctAnswer = a - b;
    else if (operator === '*') correctAnswer = a * b;
    else { // '/'
      a = a * b; // make division exact
      correctAnswer = a / b;
    }

    questionEl.textContent = `${a} ${operator} ${b} = ?`;
    answerInput.value = '';
    feedbackEl.textContent = '';
  } 
  else if (subject === 'gk') {
    // set answer input to text mode for GK answers
    try { answerInput.type = 'text'; } catch(e){}
    try { answerInput.inputMode = 'text'; } catch(e){}

    // General Knowledge questions
    if (!Array.isArray(gkQuestions) || gkQuestions.length === 0) {
      questionEl.textContent = "GK questions loading...";
      correctAnswer = null;
      answerInput.value = '';
      feedbackEl.textContent = '';
      return;
    }

    const q = gkQuestions[Math.floor(Math.random() * gkQuestions.length)];
    questionEl.textContent = q.question;
    // store expected answer as string (lowercase trimmed)
    correctAnswer = (typeof q.answer === 'string') ? q.answer.trim().toLowerCase() : String(q.answer).trim().toLowerCase();
    answerInput.value = '';
    feedbackEl.textContent = '';
  } 
  else {
    // fallback
    questionEl.textContent = 'No questions available for this subject yet.';
    correctAnswer = null;
  }
}

/* ===== Answer checking ===== */
function checkAnswer(){
  if (correctAnswer === undefined || correctAnswer === null) {
    feedbackEl.textContent = 'No question ready.';
    return;
  }
  const subject = subjectSelect.value || 'math';
  let raw = (answerInput.value || '').toString().trim();
  if (raw === '') { feedbackEl.textContent = 'Please enter an answer.'; return; }

  let correct = false;

  if (subject === 'math') {
    // numeric comparison (allow numeric string input)
    const userVal = Number(raw);
    if (Number.isNaN(userVal)) { feedbackEl.textContent = 'Enter a valid number.'; return; }
    if (userVal === correctAnswer) correct = true;
  } else {
    // textual comparison, case-insensitive
    const userText = raw.toLowerCase();
    if (userText === correctAnswer) correct = true;
  }

  if (correct) {
    score++;
    feedbackEl.textContent = '‚úÖ Correct!';
  } else {
    // show correct answer (for text answers it's already a lowercase string)
    const displayAnswer = (subject === 'math') ? correctAnswer : correctAnswer;
    feedbackEl.textContent = `‚ùå Wrong! The answer was ${displayAnswer}`;
  }

  // update high score & local storage
  if (score > highScore) highScore = score;

  // ensure persistence both local and server
  localStorage.setItem('score', String(score));
  localStorage.setItem('highScore', String(highScore));
  localStorage.setItem('rankIndex', String(currentRankIndex));

  updateDisplay();
  checkLevelUp();
  // save to server (if logged in) and refresh leaderboard
  saveUser();
  generateQuestion();
  loadLeaderboard();
}

/* ===== Persistence: server calls =====
   Endpoints required on server:
   GET  /user/:username
   POST /user/:username   (body: {score, highScore, currentRankIndex})
   GET  /users
   (ranks.json should be served statically under /ranks.json)
*/
function saveUser(){
  // always update localStorage
  localStorage.setItem('score', String(score));
  localStorage.setItem('highScore', String(highScore));
  localStorage.setItem('rankIndex', String(currentRankIndex));

  if (!username) return; // do not post to server without username

  fetch(`/user/${encodeURIComponent(username)}`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ score, highScore, currentRankIndex })
  }).catch(err => console.error('Save user failed:', err));
}

/* ===== Leaderboard ===== */
function loadLeaderboard(){
  fetch('/users')
    .then(res => {
      if (!res.ok) throw new Error('Failed to load users');
      return res.json();
    })
    .then(data => {
      const list = Object.entries(data || {})
        .map(([user, stats]) => ({ user, highScore: Number.isFinite(stats.highScore) ? stats.highScore : (stats.highScore ? Number(stats.highScore) : 0) }))
        .sort((a,b) => b.highScore - a.highScore)
        .slice(0,10);

      leaderboardList.innerHTML = '';
      list.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.user} ‚Äî ${item.highScore} pts`;
        leaderboardList.appendChild(li);
      });
    })
    .catch(err => {
      console.error('Leaderboard error:', err);
      leaderboardList.innerHTML = '<li>Error loading leaderboard</li>';
    });
}

/* ===== Load GK questions (large pool) ===== */
fetch('gk.json')
  .then(res => {
    if (!res.ok) throw new Error('gk.json not found: ' + res.status);
    return res.json();
  })
  .then(data => {
    if (Array.isArray(data)) gkQuestions = data;
    console.log("GK questions loaded:", gkQuestions.length);
  })
  .catch(err => console.warn('Failed to load GK questions:', err));

/* ===== Load ranks then user ===== */
function fetchRanksThenStart(){
  // ranks.json must be in /public/ranks.json so static server serves it at /ranks.json
  fetch('/ranks.json')
    .then(res => {
      if (!res.ok) throw new Error('ranks.json not found (status ' + res.status + ')');
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) throw new Error('ranks.json invalid');
      ranks = data;
      sanitizeRankIndex();
      // restore saved subject here too (in case it was set earlier)
      const saved = localStorage.getItem('quiz_subject');
      if (saved && Array.from(subjectSelect.options).some(o => o.value === saved)) {
        subjectSelect.value = saved;
      }
      setUIEnabled(true);
      updateDisplay();
      generateQuestion();
      loadLeaderboard();
      console.log('Ranks loaded:', ranks);
    })
    .catch(err => {
      console.error('Failed to load ranks:', err);
      questionEl.textContent = 'Error loading ranks.';
      feedbackEl.textContent = 'Check ranks.json on server.';
    });
}

/* ===== Login / Load user ===== */
function createLoginControls(){
  const saved = localStorage.getItem('quiz_username');
  const input = document.createElement('input');
  input.placeholder = 'username';
  input.style.padding = '8px';
  input.style.fontSize = '14px';
  input.value = saved || '';

  const btn = document.createElement('button');
  btn.textContent = saved ? 'Use saved / Switch' : 'Login';
  btn.onclick = () => {
    const val = (input.value || '').trim();
    if (!val) { alert('Enter a username (letters/numbers).'); return; }
    username = val;
    localStorage.setItem('quiz_username', username);
    loginArea.innerHTML = `Logged in as: <strong>${username}</strong>`;
    // load user data then ranks
    fetch(`/user/${encodeURIComponent(username)}`)
      .then(res => {
        if (!res.ok) throw new Error('User not found');
        return res.json();
      })
      .then(data => {
        // prefer server values, but validate them
        score = Number.isFinite(data.score) ? data.score : (parseInt(localStorage.getItem('score')) || 0);
        highScore = Number.isFinite(data.highScore) ? data.highScore : (parseInt(localStorage.getItem('highScore')) || 0);
        currentRankIndex = Number.isFinite(data.currentRankIndex) ? data.currentRankIndex : (parseInt(localStorage.getItem('rankIndex')) || 0);
        updateDisplay();
        fetchRanksThenStart();
      })
      .catch(() => {
        // New user or server missing ‚Äî use localStorage fallback
        score = parseInt(localStorage.getItem('score')) || 0;
        highScore = parseInt(localStorage.getItem('highScore')) || 0;
        currentRankIndex = parseInt(localStorage.getItem('rankIndex')) || 0;
        updateDisplay();
        fetchRanksThenStart();
      });
  };

  const clearBtn = document.createElement('button');
  clearBtn.textContent = 'Clear saved';
  clearBtn.onclick = () => {
    localStorage.removeItem('quiz_username');
    input.value = '';
    username = null;
    loginArea.innerHTML = '';
    createLoginControls(); // recreate
    setUIEnabled(false);
  };

  loginArea.appendChild(input);
  loginArea.appendChild(btn);
  loginArea.appendChild(clearBtn);
}

/* ===== Subject change persistence ===== */
// Save subject when the user changes it, and regenerate a question if UI is enabled.
subjectSelect.addEventListener('change', () => {
  localStorage.setItem('quiz_subject', subjectSelect.value);
  // only regenerate if UI is enabled (avoids running before ranks loaded)
  if (!answerInput.disabled) {
    generateQuestion();
  }
});

/* ===== Initialization ===== */
(function init(){
  setUIEnabled(false); // start disabled until ranks & login
  createLoginControls();
  // Try auto-login if username saved and button not pressed yet:
  const s = localStorage.getItem('quiz_username');
  if (s) {
    // simulate pressing login button to load user and ranks:
    username = s;
    loginArea.innerHTML = `Logged in as: <strong>${username}</strong>`;
    fetch(`/user/${encodeURIComponent(username)}`)
      .then(res => {
        if (!res.ok) throw new Error('User not found');
        return res.json();
      })
      .then(data => {
        score = Number.isFinite(data.score) ? data.score : (parseInt(localStorage.getItem('score')) || 0);
        highScore = Number.isFinite(data.highScore) ? data.highScore : (parseInt(localStorage.getItem('highScore')) || 0);
        currentRankIndex = Number.isFinite(data.currentRankIndex) ? data.currentRankIndex : (parseInt(localStorage.getItem('rankIndex')) || 0);
        updateDisplay();
        fetchRanksThenStart();
      })
      .catch(() => {
        score = parseInt(localStorage.getItem('score')) || 0;
        highScore = parseInt(localStorage.getItem('highScore')) || 0;
        currentRankIndex = parseInt(localStorage.getItem('rankIndex')) || 0;
        updateDisplay();
        fetchRanksThenStart();
      });
  } else {
    // no saved username ‚Äî still fetch ranks so the UI becomes available (user can then login)
    fetchRanksThenStart();
  }
})();

/* allow Enter to submit */
answerInput.addEventListener('keydown', function(e){ if (e.key === 'Enter') checkAnswer(); });

</script>

<footer>
  ¬©2025 ANICADE ‚õ©Ô∏è Productions (ANICADE's ELEVATE)
</footer>
</body>
</html>